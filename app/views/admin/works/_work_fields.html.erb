<%= content_tag(:fieldset, "data-controller": "work-dropdowns") do %>
  <%= f.input :medium, as: :select,
    collection: Work.media_options,
    input_html: {
      # "data-controller": "selectize",
      # "data-target":     "work-dropdowns.medium"
    }
  %>

  <%= f.input :title %>

  <%= content_tag(:fieldset,
    class:  join_class_names("legendary", "fields_for", ("fieldset-with-errors" if f.object.errors[:contributions].any?)),
    "data-controller": "expandable-has-many"
  ) do %>
    <%= content_tag(:legend) do %>
      Contributors <%= required_indicator %>
    <% end %>

    <%= content_tag(:div, class: "hint") do %>
      <% if f.object.errors[:contributions].any? %>
        <%= f.error :contributions %>
      <% else %>
        Choose at least one creator.
      <% end %>
    <% end %>

    <% f.object.contributions.each do |contribution| %>
      <%= f.simple_fields_for :contributions, contribution do |ff| %>
        <%= content_tag(:fieldset, class: "contribution") do %>
          <%= content_tag(:div, class: "stacked") do %>
            <%= ff.input :creator_id,
              as:            :select,
              collection:    creators,
              required:      false,
              include_blank: true,
              error:         false,
              input_html:    {
                "data-controller":              "selectize-create",
                "data-selectize-create-action": admin_creators_path,
                "data-selectize-create-method": "POST",
                "data-selectize-create-param":  "creator[name]"
              }
            %>

            <%= ff.input :role, as: :grouped_select,
              collection:         roles,
              required:           false,
              group_label_method: :first,
              group_method:       :last,
              include_blank:      true,
              input_html:         {
                # "data-controller": "selectize",
                "data-target":     "work-dropdowns.role"
              }
            %>
          <% end %>

          <%= ff.error :creator_id %>
          <%= ff.error :role %>

          <%= render(partial: "shared/custom_checkbox", locals: {
            f:    ff,
            name: :_destroy
          }) unless ff.object.new_record? %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
