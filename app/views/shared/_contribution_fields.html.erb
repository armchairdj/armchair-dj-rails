<%
  fieldset_classes = [
    "legendary",
    "fields_for",
    ("fieldset-with-errors" if f.object.errors[:contributions].any?)
  ].compact.join(" ")
%>

<%= content_tag(:fieldset, class: fieldset_classes, "data-controller": "expandable-has-many") do %>
  <%= content_tag(:legend) do %>
    Contributors <%= required_indicator %>
  <% end %>

  <%= content_tag(:div, class: "hint") do %>
    Choose at least one creator.
  <% end %>

  <% f.object.contributions.each do |contribution| %>
    <%= f.simple_fields_for :contributions, contribution do |ff| %>
      <%= content_tag(:fieldset, class: "contribution") do %>
        <%= content_tag(:div, class: "stacked") do %>
          <%= ff.input :creator_id,
            as:            :select,
            collection:    creators,
            required:      false,
            include_blank: true,
            error:         false,
            input_html:    {
              "data-controller":           "select-create",
              "data-select-create-action": creators_path,
              "data-select-create-method": "POST",
              "data-select-create-param":  "creator[name]"
            }
          %>

          <%= ff.input :role,
            as:            :select,
            collection:    roles,
            required:      false,
            include_blank: false,
            error:         false
          %>
        <% end %>

        <%= ff.error :creator_id %>
        <%= ff.error :role %>

        <%= render(partial: "shared/custom_checkbox", locals: {
          f:    ff,
          name: :_destroy
        }) unless ff.object.new_record? %>
      <% end %>
    <% end %>
  <% end %>

  <%= f.error :contributions %>
<% end %>
